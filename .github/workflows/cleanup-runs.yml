name: Cleanup Old Workflow Runs

on:
  schedule:
    # 每月1号凌晨2点执行（UTC时间）
    - cron: '0 2 1 * *'
  workflow_dispatch: # 允许手动触发

permissions:
  contents: read
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            // 获取所有工作流
            const workflows = await github.paginate(
              github.rest.actions.listRepoWorkflows,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
              }
            );

            console.log(`找到 ${workflows.length} 个工作流`);

            for (const workflow of workflows) {
              console.log(`\n处理工作流: ${workflow.name} (ID: ${workflow.id})`);
              
              // 获取该工作流的所有运行记录
              const runs = await github.paginate(
                github.rest.actions.listWorkflowRuns,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow.id,
                }
              );

              console.log(`  找到 ${runs.length} 个运行记录`);

              // 如果运行记录超过6个，删除旧的
              if (runs.length > 6) {
                const runsToDelete = runs.slice(6);
                console.log(`  将删除 ${runsToDelete.length} 个旧运行记录`);

                for (const run of runsToDelete) {
                  try {
                    await github.rest.actions.deleteWorkflowRun({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      run_id: run.id,
                    });
                    console.log(`    ✓ 已删除运行记录 #${run.run_number} (ID: ${run.id})`);
                  } catch (error) {
                    console.log(`    ✗ 删除运行记录 #${run.run_number} 失败: ${error.message}`);
                  }
                }
              } else {
                console.log(`  运行记录数量未超过6个，无需删除`);
              }
            }

            console.log('\n清理完成！');
